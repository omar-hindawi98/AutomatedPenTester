#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from jumpssh import SSHSession 
from jumpssh.exception import RunCmdError

'''
Class for managing SSH connections
'''
class Session():
    def __init__(self, topology, target):
        self._connected = False

        # Variables
        self._connections = []

        # Find way to target
        self._tool_is_host = True

        target_topology = [(k, v) for k, v in topology.items() if v["host"] == target][0]

        if target_topology[1]["parent"] != "tool":
            self._tool_is_host = False
        
        # Filter and get only the important path in topology
        self._topology = []
        current = target_topology[0]
        for _ in range(len(topology.keys())):
            self._topology.insert(0, topology[current])

            current = topology[current]["parent"]

            # Break if reached null target
            if current == None:
                break

    '''
    Get sudo with password
    '''
    def _get_sudo_cmd(self, cmd, index):
        return f"echo {self._topology[index]['password']} | sudo -S sh -c '{cmd}'"

    '''
    Runs cmd on preceding host
    '''
    def run_cmd(self, cmd, use_sudo = True):
        if len(self._connections) > 1:
            if use_sudo:
                self._connections[-2].run_cmd(self._get_sudo_cmd(cmd, -2), silent=True)
            else:
                self._connections[-2].run_cmd(cmd, silent=True)
        else:
            raise Exception("More than 1 connection must be present")

    '''
    Runs cmd on target
    '''
    def run_cmd_target(self, cmd, use_sudo = True):
        if len(self._connections) > 0:
            if use_sudo:
                self._connections[-1].run_cmd(self._get_sudo_cmd(cmd, -1), silent=True)
            else:
                self._connections[-1].run_cmd(cmd, silent=True)
        else:
            raise Exception("More than 0 connections must be present")

    '''
    Runs cmd on preceding host
    '''
    def get_cmd(self, cmd, use_sudo = True):
        if len(self._connections) > 1:
            return self._connections[-2].get_cmd_output(cmd, username=self._topology[-2]["user"])
        else:
            raise Exception("More than 1 connections must be present")

    '''
    Runs cmd on target
    '''
    def get_cmd_target(self, cmd, use_sudo = True):
        if len(self._connections) > 0:
            return self._connections[-1].get_cmd_output(cmd)
        else:
            raise Exception("More than 0 connections must be present")
        
    '''
    '''
    def connect_ssh(self):
        self._connected = True

        # Create SSH connection to tool host
        self._connections.append(
            SSHSession(
                self._topology[0]["host"],
                self._topology[0]["user"],
                password=self._topology[0]["password"],
                look_for_keys=False,
                auth_timeout=30,
                timeout=12000,
            ).open()
        )

        # Create connection to all targets within the fixed topology
        for i in range(1, len(self._topology)):
            self._connections.append(
                self._connections[i - 1].get_remote_session(
                    self._topology[i]["host"],
                    self._topology[i]["user"],
                    password=self._topology[i]["password"],
                    look_for_keys=False,
                    auth_timeout=30,
                    timeout=12000,
                )
            )

    '''
    Get file from remote preceding host
    '''
    def get_file(self, remote_path, local_path, use_sudo = False, username = None):
        if self._connected:
            if len(self._connections) > 1:
                return self._connections[-2].get(remote_path=remote_path, local_path=local_path, use_sudo=use_sudo, username=username)
            else:
                raise Exception("More than 1 connections must be present")
        
        raise Exception("Session is not connected")


    '''
    Get file from remote target host
    '''
    def get_file_target(self, remote_path, local_path, use_sudo = False, username = None):
            if len(self._connections) > 0:
                return self._connections[-1].get(remote_path, local_path, use_sudo, username)
            else:
                raise Exception("More than 0 connections must be present")

    '''
    Disconnect from all SSH hosts
    '''
    def disconnect(self):
        self._connected = False

        for con in self._connections:
            con.close()