#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from abc import ABC, abstractmethod
import logging
from core.helper import remove_suffix, tool_config
import importlib
import json
import os
import inspect

logger = logging.getLogger(__name__)

'''
Abstract class for Modules
'''
class Module(ABC):
    def __init__(self, config, general_config, session):
        # TODO change the config names so they make sense
        self._config = config
        self._session = session
        self._general_config = general_config
        self._tool_config = tool_config()["General"]
        self._type = []
        self._result = None

    def log(self, message, type = "info"):
        m_message = f"[{self.__class__.__name__}] {message}"

        if type == "info":
            logger.info(m_message)
        elif type == "error":
            logger.error(m_message)
        elif type == "debug":
            logger.debug(m_message)
        elif type == "warn":
            logger.warn(m_message)

    @abstractmethod
    def init():
        pass

    @abstractmethod
    def run():
        pass

    @abstractmethod
    def parse():
        pass

    @abstractmethod
    def get_result():
        pass

    '''
    Used to save parsed result for regression tests
    '''
    def save_result(self, result):
        self._result = result

    '''
    Runs CMD on Session
    '''
    def run_cmd(self, cmd):
        pass

    '''
    Checks all regression cases in module file
    '''
    def check_regtests(self):
        # Get class name
        module_name = remove_suffix(self.__class__.__name__, "Module").lower()

        # SKIP Threading here, locking is -_-
        # Check each regression test in module file
        for name, cls in inspect.getmembers(importlib.import_module(f'modules.{module_name.lower()}'), inspect.isclass):
            if name.endswith("Regression"):
                regtest = cls(self._result)
                res = regtest.check()
                reg_name = remove_suffix(name, "Regression")

                file_path = os.path.join(f'{os.getcwd()}/targets', self._general_config["target"]) + f"/regtests/{module_name}.json"

                # Create or append to regression test file if found
                if res:
                    data = {}

                    if os.path.exists(file_path):
                        with open(file_path, 'r') as f:
                            data = json.load(f)

                        # Replace old regression (Or instert new)
                        data[reg_name] = res

                        # Append to json
                        with open(file_path, 'w') as f:
                            json.dump(data, f, indent=4, sort_keys=True)
                    else:
                        data[reg_name] = res
                        # Create new file with json
                        with open(file_path, 'w') as f:
                            json.dump(data, f, indent=4, sort_keys=True)