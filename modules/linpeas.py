#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from core.linpeas_parser import linpeas_parser
import json
import os
import re
from core.constants import IG, INTERNAL
from core.module import Module

"""
Define core module here
"""


class LinpeasModule(Module):
    _type = [IG]
    _services = []
    _target_type = INTERNAL
    _defaults = {
        "superfast": False,
        "allchecks": False
    }
    _extension = ".txt"

    def run(self):
        cmd = ["./linpeas.sh"]

        # Read settings, set cmd
        for key, value in self.config().items():
            if key == "superfast" and value == "True":
                cmd.append("-s")
            elif key == "allchecks" and value == "True":
                cmd.append("-a")

        # Output to file
        cmd.extend([">", self._tmpfile_loc()])

        # run linpeas && save to text ouput
        self.run_cmd(cmd)

    def parse(self):
        target_loc = f"{os.getcwd()}/targets/{self._target}/results"

        json_res = linpeas_parser(f"{target_loc}/linpeas_result.txt")

        with open(f"{target_loc}/linpeas_result.json", "w") as f:
            json.dump(json_res, f)

    def init(self):
        # Check if file exists, download it if not
        try:
            self.run_cmd(
                "wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh && chmod +x linpeas.sh"
            )
        except Exception:
            pass