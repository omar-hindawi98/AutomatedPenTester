#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from core.constants import EXTERNAL
import logging
import subprocess
import sys
from core.regressiontest import RegressionTest
from core.module import Module
from xml.etree import ElementTree as ET
import subprocess
import xmltodict
import json
import sys
import os

'''
Define core module here
'''
class NmapModule(Module):   
    _type = ["IG"]
    _services = []
    _target_type = EXTERNAL
    _defaults = {
        "asd": True,
        "wtf": "test"
    }

    def run(self):
        command = ["nmap", "-sS", "-A", "-p-", "-v", "-oX", (self._tmp + ".xml")]     # get command from JSON later

        try:
            subprocess.run(command + [self._target])
            # Add subprocess functions?
            # Save output into correct target dir.
            # Save how? txt. xml etc?

        except OSError as err:
            self.log(f"Execution failed: {err}", "error")

    def parse(self):
        print("\n[PARSING NMAP RESULTS]")

        # Get current dir and check that path exists, else create path.
        target_loc = f'{os.getcwd()}\\targets\{self._target}\\nmap_scans'
        if not os.path.exists(target_loc):
            os.mkdir(os.path.join(target_loc))

        # Open scan and convert it to json
        if os.path.exists(f"{target_loc}\\recent_scan.xml"):
            with open(f"{target_loc}\\recent_scan.xml", "r") as f:
                xml = json.dumps(xmltodict.parse(f.read()), indent=4, sort_keys=True)
                f.close()

            # Create new json per scan
            file_count = len(os.listdir(target_loc))
            with open(f'{target_loc}/scan_{file_count}.json', 'w') as f:
                f.write(xml)
                f.close()

            # Save results for regression tests to retrieve
            super().save_result("")
    
    def init(self):
        pass
    
    def get_result(self):
        pass
        #save_loc = f'{os.getcwd()}\\targets\{target}\\nmap_scans
        #if os.system(remote_session.exists('self._tool_config[General][rlocation]')):
        #    remote_session.get('self._tool_config[General][rlocation]', 'save_loc')

'''
Define regression tests here
'''
class NmapPortRegression(RegressionTest):
    def run(self):
        pass
    
    def parse(self):
        pass
    
    def get_result(self):
        pass

    def check(self):
        return {
            "cmd": [""],
            "payload": [""],
            "config": {
                
            }
        }

'''
Define regression tests here
'''
class NmapBruhRegression(RegressionTest):
    def run(self):
        pass
    
    def parse(self):
        pass
    
    def get_result(self):
        pass

    def check(self):
        return {
            "asd": [""],
            "a": [""],
            "fwe": {
                
            }
        }
