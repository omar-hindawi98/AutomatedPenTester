#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from core.constants import EX, EXTERNAL
from core.helper import logger_class
from core.module import Module


class DirbModule(Module):
    _type = [EX]
    _services = ["http", "https"]
    _target_type = EXTERNAL
    _defaults = {
        "cookie": "",
        "agent": "",
        "case-insensitive": False
        }
    _extension = ".txt"

    def run(self):
        # Scan each service & port in payload
        for port in self._payload:
            logger_class(self, f"Scanning port: {port[0]} on service {port[1]}", "info")

            cmd = ["dirb", f"{port[1]}://{self._target}:{port[0]}"]

            # Read settings, set cmd
            for key, value in self._config:
                if(key == "cookie" and value != ""):
                    cmd.extend("-c", value)
                elif(key == "agent" and value != ""):
                    cmd.extend("-a", value)
                elif(key == "case-insensitive" and value == "True"):
                    cmd.append("-i")

            # Add output
            cmd.extend(["-o", {self._tmpfile_loc()}])

            # Perform scan
            self.run_cmd(cmd)

    def parse(self):
        # TODO: Parse output
        pass

    def init(self):
        pass
