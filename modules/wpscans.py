#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from core.constants import EX, EXTERNAL
from core.helper import logger_class
from core.module import Module


class WpscansModule(Module):
    _type = [EX]
    _services = ["http", "https"]
    _target_type = EXTERNAL
    _defaults = {
        "stealthy": False,
        "disable-tls": False,
        "max-threads": 5,
        "throttle": 1,
        "themes": "ap",
        "plugins": "at",
        "config-backups": True,
        "db-exports": True,
        "timthumbs": True,
        "update-db": False
    }
    _extension = ".json"

    def run(self):
        # Scan each service & port in payload
        for port in self._payload["ports"]:
            logger_class(self, f"Scanning port: {port[0]} on service {port[1]}", "info")

            cmd = ["wpscan", "--url"]

            # Specify target
            cmd.append(f"{port[1]}://{self._target}:{port[0]}")

            # Read settings, set cmd
            enumerate = []
            for key, value in self.config().items():
                if(key == "stealthy" and value == "True"):
                    cmd.append("--stealthy")
                elif(key == "disable-tls" and value == "True"):
                    cmd.append("--disable-tls-checks")
                elif(key == "max-threads"):
                    cmd.extend(["--max-threads", value])
                elif(key == "throttle"):
                    cmd.extend(["--throttle", value])
                elif(key == "themes" or key == "plugins"):
                    enumerate.append(value)
                elif(key == "config-backups" and value == "True"):
                    enumerate.append("cb")
                elif(key == "db-exports" and value == "True"):
                    enumerate.append("dbe")
                elif(key == "timthumbs" and value == "True"):
                    enumerate.append("tt")
            
            # Prevent update
            cmd.append("--no-update")

            cmd.extend(["--enumerate", ",".join(enumerate)])

            # Add output
            cmd.extend(["-o", self._tmpfile_loc()])

            # Perform scan
            try:
                self.run_cmd(cmd)
            except:
                logger_class(self, "Failed to run due to no DB available", "warn")

    def parse(self):
        # Already in json
        pass

    def init(self):
        try: 
            if int(self.config()["throttle"]) == 0:
                self.set_config("throttle", 0)
        except Exception:
            pass

        ## Try to update DB
        try:
            logger_class(self, "Trying to update DB", "debug")
            self.run_cmd("wpscan --update")
        except Exception:
            logger_class(self, "Failed to update DB", "debug")

