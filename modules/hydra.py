#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import json
import os
from core.regressiontest import RegressionTest
from core.helper import logger_class
from core.constants import EX, EXTERNAL
from core.module import Module


class HydraModule(Module):
    _type = [EX]
    _services = [
        "afp",
        "cisco",
        "aaa",
        "cisco",
        "auth",
        "cisco",
        "enable",
        "cvs",
        "firebird",
        "ftp",
        "ftps",
        "http-form-get",
        "http-form-post",
        "http-get",
        "http-head",
        "http-proxy",
        "http-proxy-urlenum",
        "icq",
        "imap",
        "irc",
        "ldap2",
        "ldap3",
        "ms-sql",
        "mysql",
        "ncp",
        "nntp",
        "oracle",
        "oracle-listener",
        "oracle-sid",
        "pc-anywhere",
        "pcnfs",
        "pop3",
        "postgres",
        "rdp",
        "rexec",
        "rlogin",
        "rsh",
        "sap/r3",
        "sip",
        "smb",
        "smtp",
        "smtp-enum",
        "snmp",
        "socks5",
        "ssh",
        "sshkey",
        "subversion",
        "teamspeak",
        "(ts2)",
        "telnet",
        "vmware-auth",
        "vnc",
        "xmpp",
    ]
    _target_type = EXTERNAL
    _defaults = {
        "threads": 16,
        "common_password_list": "",
        "users": "root"  # Add more users by separating with comma, eg. root,test,admin
        }
    _extension = ".json"

    def run(self):
        for port in self._payload["ports"]:
            logger_class(self, f"Bruteforcing: {port[0]} on service {port[1]}", "info")
            cmd = ["hydra", "-L", f"{self._tmp}tmp_userlist_{self._target}.txt", "-p", self._config["common_password_list"]]

            # Read settings, set cmd
            for key, value in self.config().items():
                if key == "threads":
                    cmd.extend(["-t", value])

            # Add output
            cmd.extend(["-b", self._extension.replace(".", "")])  # Ouput format
            cmd.extend(["-o", self._tmpfile_loc(port[0])])  # Output file

            # Add server, service & port to bruteforce
            cmd.extend(["-s", port[0]])
            cmd.extend([self._target, port[1]])

            # Perform scan
            try:
                self.run_cmd(cmd)
            except Exception:
                logger_class(self, f"Error when bruteforcing {port[0]} on service {port[1]}", "error")

    def parse(self):
        # Does not need any
        pass

    def init(self):
        # Set common password list if empty
        if self.config()["common_password_list"] == "":
            self.set_config("common_password_list", self._tool_config["common_password_list"])

        # Create temporary user word list from string
        users_formatted = self._config["users"].replace(" ", "").replace(",", "\n")
        self.run_cmd(f"echo $\"{users_formatted}\" > {self._tmp}tmp_userlist_{self._target}.txt")


"""
Define regression tests here
"""


class HydraPasswordCheckRegression(RegressionTest):
    _extension = ".json" # Specifies what extension the result file has
    _description = "Checks if a combination of username and password still works"
    _defaults = {
        
    }

    def run(self):
        for port in self._payload["ports"]:
            user = port["user"]
            password = port["password"]

            cmd = ["hydra", "-l", user, "-p", password]

            # Add output
            cmd.extend(["-b", self._extension.replace(".", "")])  # Ouput format
            cmd.extend(["-o", self._tmpfile_loc(port[0])])  # Output file

            # Add server, service & port to bruteforce
            cmd.extend(["-s", port["port"]])
            cmd.extend([self._target, port["service"]])

            # Perform scan
            self.run_cmd(cmd)

    def parse(self):
        result = {port: "failed" for port in self._payload["ports"]}

        # Read multiple json objs from hydra regtest file
        with open(
            f"{os.getcwd()}/targets/{self._target}/regtests/{self._res_name}.json",
            "r"
        ) as f:
            # Go through each object
            for hydra_resobj in f:
                hydra_res = json.loads(hydra_resobj)

                if hydra_res["success"]:
                    # Check result
                    for res in hydra_res["results"]:
                        for port in self._payload["ports"]:
                            if res["port"] == port["port"] \
                                and res["user"] == port["user"] \
                                and res["password"] == port["password"] \
                                and res["service"] == port["service"]:
                                
                                result[res["port"]] = "success"
                                break
        
        with open(
            f"{os.getcwd()}/targets/{self._target}/regtests/{self._res_name}.json",
            "w"
        ):
            f.write(json.dumps(result, indent=4))

    def check(target):
        ports = []
        # Read multiple json objs from hydra file
        try:
            with open(
                f"{os.getcwd()}/targets/{target}/results/hydra_result.json",
                "r"
            ) as f:
                data = json.loads(f.read())

                # Go through each object
                for _, hydra_res in data.items():
                    if hydra_res["success"]:
                        # Check result
                        for res in hydra_res["results"]:
                            # Append to ports payload
                            ports.append({
                                "user": res["login"],
                                "password": res["password"],
                                "port": res["port"],
                                "service": res["service"]
                            })
            
            if len(ports) == 0:
                return None
            
            return {"ports": ports}
        except IOError:
            return None